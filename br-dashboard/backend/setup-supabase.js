const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabase = createClient(supabaseUrl, supabaseKey);

async function setupDatabase() {
    console.log('üöÄ Iniciando configura√ß√£o do banco de dados Supabase...');

    try {
        // Nota: Como n√£o podemos rodar SQL arbitr√°rio diretamente via supabase-js sem RPC ou extens√µes,
        // vamos tentar fazer um insert de teste que falhar√° se a tabela n√£o existir, 
        // ou simplesmente informar o usu√°rio para rodar o SQL no painel se preferir.
        // No entanto, podemos usar a API de 'rest' para verificar se a tabela existe.

        const { error: checkError } = await supabase
            .from('products')
            .select('id')
            .limit(1);

        if (checkError && checkError.code === 'PGRST116') {
            console.log('üìù Tabela "products" n√£o encontrada. Criando estrutura via SQL...');
            // O Supabase n√£o permite criar tabelas via supabase-js (apenas via SQL Editor ou API de Gest√£o)
            // Vou instruir o usu√°rio ou tentar usar um comando curl para a API de Gest√£o se poss√≠vel.
            // MAIS SEGURO: Usar o RPC se estiver dispon√≠vel ou pedir para o usu√°rio colar o SQL.

            console.log('\n‚ö†Ô∏è  A√á√ÉO REQUERIDA: V√° ao "SQL Editor" do seu painel Supabase e cole o seguinte comando:');
            console.log(`
CREATE TABLE IF NOT EXISTS products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  quantity INTEGER DEFAULT 0,
  minimum_stock INTEGER DEFAULT 0,
  category TEXT DEFAULT 'Geral',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Habilitar Realtime
alter publication supabase_realtime add table products;
      `);
        } else if (checkError) {
            console.error('‚ùå Erro ao verificar tabela:', checkError.message);
        } else {
            console.log('‚úÖ Tabela "products" j√° existe e est√° acess√≠vel.');
        }

    } catch (error) {
        console.error('‚ùå Erro fatal no setup:', error.message);
    }
}

setupDatabase();
